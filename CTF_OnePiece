TryHackMe Write Up - CTF: One Piece

Scan:
  Result:
    PORT   STATE SERVICE VERSION
    21/tcp open  ftp     vsftpd 3.0.3
    | ftp-anon: Anonymous FTP login allowed (FTP code 230)
    |_-rw-r--r--    1 0        0             187 Jul 26 07:27 welcome.txt
    | ftp-syst: 
    |   STAT: 
    | FTP server status:
    |      Connected to ::ffff:10.9.35.171
    |      Logged in as ftp
    |      TYPE: ASCII
    |      No session bandwidth limit
    |      Session timeout in seconds is 300
    |      Control connection is plain text
    |      Data connections will be plain text
    |      At session startup, client count was 3
    |      vsFTPd 3.0.3 - secure, fast, stable
    |_End of status
    22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
    | ssh-hostkey: 
    |   2048 01:18:18:f9:b7:8a:c3:6c:7f:92:2d:93:90:55:a1:29 (RSA)
    |   256 cc:02:18:a9:b5:2b:49:e4:5b:77:f9:6e:c2:db:c9:0d (ECDSA)
    |_  256 b8:52:72:e6:2a:d5:7e:56:3d:16:7b:bc:51:8c:7b:2a (ED25519)
    80/tcp open  http    Apache httpd 2.4.29 ((Ubuntu))
    |_http-server-header: Apache/2.4.29 (Ubuntu)
    |_http-title: New World
Thanks to the scan we can see that the anonymous FTP login is allowed.

FTP:
  We can see a file welcome.txt and a hidden directory .the_whale_tree
  Get the txt file and go the hidden directory.
  We can see 2 hidden files, .road_poneglyph.jpeg and .secret_room.txt
  Get both hidden files.
  The file .secret_room contains the answer to Task 2 - Question 1: "The Whale"
  Extract with steghide (no password) from .road_poneglyph.jpeg. You get the 1st encoded road poneglyph. Keep it.

Apache:
  index.html:
    The comment of the html source code can be decoded as follow: Base32 => Base64 => Base85
    Result: "Nami ensures there are precisely 3472 possible places where she could have lost it."
    OSINT: GitHub
      Search "LogPose": It contains a list of 3472 words. Save this list into a txt file (logpose.txt).
    Enumerate the website with this list. The html extension must be precised:
    Command: gobuster dir -u 10.10.113.231 -w logpose.txt -x html
    Result: dr3ssr0s4.html
  
  dr3ssr0s4.html:
    The answer for the 2nd question is written: "Donquixote Doflamingo"
    Rabbit Hole: The black screen with part that disappears when the mouse is on it.
      1st line: 6b 65 79 3a 69 6d 20 6f 6e 20 6f 74 69 20 6f 74 69
        Decoded with hex => key:im on oti oti
      2nd line: m5.J`/{{#F%&!5Gl}+n<a
        Decoded with base91 => ito ito no mi:yek
      3rd line: Lhtttavbsw ql gbbzy gfivwwvz
        Decrypted with vigenere (key is itoitonomi) => Doflamingo is still standing
    Page source:
      Go to /css/dressrosa_style.css
      You can find an image ../king_kong_gun.jpg (this image is actually behind the first one on the screen)
      king_kong_gun.jpg:
        Exiftool on this image, you get a comment: Doflamingo is /ko.jpg
        Go to /ko.jpg
      ko.jpg:
        Strings on this image, the last line is: Congratulations, this is the Log Pose that should lead you to the next island: /wh0l3_c4k3.php
  
  wh0l3_c4k3.php:
    The answer for the 3rd question is written: "Whole Cake".
    Rabbit Hole: Post Form
      There is nothing to do here as the input is not treated.
    Source code:
      There is a comment which is a hint: Big Mom likes cakes
    Cookie:
      The cookie value is currently: NoCakeForYou
      Change it with whatever you want, example: CakeForYou
      Reset the page: 
        You get the 2nd encoded road poneglyph. Keep it.
        You get the link for the next location: /r4nd0m.html

  r4nd0m.html:
    The answer for the 4th question is written: "Buggy the Clown"
    Rabbit Hole: The Brick Breaker game.
      If you finish the game or if you look at the brick_breaker.js file, you'll see that if you win you will have a prompt saying: Wait whaaaat ?? Did you cheat somehow !? Let's do another one with my other game !
    The Brain Teaser game: 
      Check the brain_teaser.js file, you'll see that on the back of the cube it is written: Log Pose: /0n1g4sh1m4.php
      
  0n1g4sh1m4.php:
    The answer for the 5th question is written: "Kaido of the Beasts"
    Rabbit Hole: Upload Form
      There is nothing to do here as the file is not treated.
    Login:
      Save the kaido.jpeg.
      Stegcracker on it using rockyou.txt (106308 attempts). Password is: imabeast 
      Result:
        You get a file: kaido_login.txt
        This file contains: Username:K1ng_0f_th3_B3@sts
      Brute force the login with rockyou.txt (17380 attempts). Password is: thebeast
      Result:
        You get the 3rd encoded road poneglyph. Keep it.
        You also get the following sentence: You succeed to run away and there is only one Road Poneglyph left to find to be able to reach Laugh Tale. Unfortunately, the location of this last Poneglyph is unknown.

  4th Road Poneglyph:
    As hinted by the last sentence the last poneglyph is at /unknown.
    It can also be found by enumeration with a classic wordlist.

  SSH creds:
    Concatenate the 4 Road Poneglyphs.
    Decoded as follow: Base32 => Morse Code => Binary => Hex => Base58 => Base64
    Result:
      M0nk3y_D_7uffy:1_w1ll_b3_th3_p1r@t3_k1ng!
      This can be used to connect with SSH.
      This is also the answer to the 6th question: "M0nk3y_D_7uffy:1_w1ll_b3_th3_p1r@t3_k1ng!"

SSH:
  There is the file laugh_tale.txt in your home directory.
  It contains the answer to Task 3 - Question 1: "Marshall D Teach"
  
  Privilege Escalation to 7uffy_vs_T3@ch: SUID
    Command: find / -type f -perm -4000 2> /dev/null
    You get a file named: gomugomunooo_king_kobraaa
    Using it you realise it is Python 3.6.9. You can use it to escalate privileges.
    Command: /usr/bin/gomugomunooo_king_kobraaa -c 'import os; os.execl("/bin/sh", "sh", "-p")'
    (It can also be done with /usr/bin/python3.6m SUID)
    You can see in /home/teach there are 2 interesting files: luffy_vs_teach.txt and .password.txt
    The file luffy_vs_teach.txt contains the answer for the 2nd question: "Willpower"
    The file .password.txt contains: 7uffy_vs_T3@ch:Wh0_w1ll_b3_th3_k1ng?
      These are the creds to log with the user 7uffy_vs_T3@ch
      It is also required to know 7uffy_vs_T3@ch's password for next step.
      Command: su 7uffy_vs_T3@ch
  
  Privilege Escalation to root: sudo
    Command: sudo -l
      Result: (ALL) /usr/local/bin/less
      However /usr/local/bin/less is a bash script:
        #!/bin/bash
        echo "Sorry, I can't tell you where is the One Piece"
    /usr/local/bin/less permissions are 777 however the append only attribute is set:
      It can only be modified by appending data.
      Command: echo bash >> /usr/local/bin/less
    Command: sudo /usr/local/bin/less
    You are now root.
    
  Find the One Piece:
    The One Piece is not in the root directory.
    It can be find with this type of command:
    Command: grep -iRl "One Piece" /
    It is located here: /usr/share/mysterious/on3_p1ec3.txt
    The file contains: One Piece: S3cr3ts_0f_tH3_W0rlD_&_0f_Th3_P@st$
    The file on3_p1ec3.txt.txt contains the answer for the last question: "S3cr3ts_0f_tH3_W0rlD_&_0f_Th3_P@st$"
    
